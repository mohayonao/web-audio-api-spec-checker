<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>web-audio-api-spec-checker</title>
</head>
<body>
  <pre id="puts"></pre>
  <script>
  window.addEventListener("DOMContentLoaded", function() {
    "use strict";

    function puts(line) {
      document.getElementById("puts").innerText += line + "\n";
    }

    function pushBaseClass(klass) {
      if (typeof klass === "function") {
        var baseClass = Object.getPrototypeOf(klass);

        if (typeof baseClass === "function" && !env[baseClass.name]) {
          env[baseClass.name] = baseClass;
        }
      }
    }

    var env = {};

    Object.getOwnPropertyNames(window).forEach(function(name) {
      if (/^[A-Z][a-zA-Z]+$/.test(name) && typeof window[name] === "function") {
        env[name] = window[name];
      }
    });

    env["AudioContext"] = window.AudioContext || window.webkitAudioContext;
    env["OfflineAudioContext"] = window.OfflineAudioContext || window.webkitOfflineAudioContext;

    pushBaseClass(env["OfflineAudioContext"]);
    pushBaseClass(env["OscillatorNode"]);

    var methodList = {
      "createBuffer": { className: "AudioBuffer", args: [ 1, 128, 44100 ] },
      "createBufferSource": { className: "AudioBufferSourceNode", args: [] },
      "createGain": { className: "GainNode", args: [] },
      "createDelay": { className: "DelayNode", args: [] },
      "createBiquadFilter": { className: "BiquadFilterNode", args: [] },
      "createIIRFilter": { className: "IIRFilterNode", args: [ new Float32Array([1,1], new Float32Array([1,1])) ] },
      "createWaveShaper": { className: "WaveShaperNode", args: [] },
      "createPanner": { className: "PannerNode", args: [] },
      "createConvolver": { className: "ConvolverNode", args: [] },
      "createDynamicsCompressor": { className: "DynamicsCompressorNode", args: [] },
      "createAnalyser": { className: "AnalyserNode", args: [] },
      "createScriptProcessor": { className: "ScriptProcessorNode", args: [ 1024, 1, 1 ] },
      "createStereoPanner": { className: "StereoPannerNode", args: [] },
      "createOscillator": { className: "OscillatorNode", args: [] },
      "createPeriodicWave": { className: "PeriodicWave", args: [ new Float32Array(4), new Float32Array(4) ] },
      "createChannelSplitter": { className: "ChannelSplitterNode", args: [] },
      "createChannelMerger": { className: "ChannelMergerNode", args: [] },
      "createSpatialPanner": { className: "SpatialPannerNode", args: [] },
      "createJavaScriptNode": { className: "JavaScriptNode", args: [ 1024, 1, 1 ] },
    };

    var context = new env["OfflineAudioContext"](1, 1024, 44100);

    Object.keys(methodList).forEach(function(methodName) {
      var className = methodList[methodName].className;
      var args = methodList[methodName].args;
      if (!env[className] && context[methodName]) {
        try {
          var node = context[methodName].apply(context, args);
          var klass = node.constructor;

          env[klass.name || className] = klass;
        } catch (e) {
          console.error(methodName, e);
        }
      }
    });

    var classList = [
      "BaseAudioContext",
      "AudioContext",
      "OfflineAudioContext",
      "AudioNode",
      "AudioSourceNode",
      "AudioDestinationNode",
      "AudioParam",
      "GainNode",
      "DelayNode",
      "AudioBuffer",
      "AudioBufferSourceNode",
      "MediaElementAudioSourceNode",
      "ScriptProcessorNode",
      "JavaScriptNode",
      "PannerNode",
      "AudioListener",
      "SpatialPannerNode",
      "SpatialListener",
      "StereoPannerNode",
      "ConvolverNode",
      "AnalyserNode",
      "ChannelSplitterNode",
      "ChannelMergerNode",
      "DynamicsCompressorNode",
      "BiquadFilterNode",
      "IIRFilterNode",
      "WaveShaperNode",
      "OscillatorNode",
      "PeriodicWave",
      "MediaStreamAudioSourceNode",
      "MediaStreamAudioDestinationNode",
    ];

    puts('// ' + window.navigator.userAgent);
    puts('');
    puts('{');

    classList.forEach(function(className) {
      if (env[className]) {
        if (window[className]) {
          puts('  "/' + className + '": { "global": "' + className + '" },');
        } else {
          puts('  "/' + className + '": { "global": false },');
        }
        Object.getOwnPropertyNames(env[className].prototype).sort().forEach(function(methodName) {
          if (methodName === "constructor") {
            return;
          }
          puts('  "/' + className + '/' + methodName + '": {},');
        });
        puts('');
      }
    });

    puts('}');
  });
  </script>
</body>
</html>
