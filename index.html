<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>web-audio-api-spec-checker</title>
</head>
<body>
  <pre id="puts"></pre>
  <script>
  window.addEventListener("DOMContentLoaded", function() {
    "use strict";

    function puts(line) {
      document.getElementById("puts").innerText += line + "\n";
    }

    function stringify(object) {
      if (Object.keys(object).length === 0) {
        return "{}";
      }
      return JSON.stringify(object)
        .replace("{", "{ ")
        .replace(/(:|,)/g, "$1 ")
        .replace("}", " }");
    }

    function pushBaseClass(klass) {
      if (typeof klass === "function") {
        var baseClass = Object.getPrototypeOf(klass);

        if (typeof baseClass === "function" && !env[baseClass.name]) {
          env[baseClass.name] = baseClass;
        }
      }
    }

    var env = {};

    Object.getOwnPropertyNames(window).forEach(function(name) {
      if (/^[A-Z][a-zA-Z]+$/.test(name) && typeof window[name] === "function") {
        env[name] = window[name];
      }
    });

    env["AudioContext"] = window.AudioContext || window.webkitAudioContext;
    env["OfflineAudioContext"] = window.OfflineAudioContext || window.webkitOfflineAudioContext;

    pushBaseClass(env["OfflineAudioContext"]);
    pushBaseClass(env["OscillatorNode"]);
    pushBaseClass(env["MediaElementAudioSourceNode"]);

    var classList = [
      "BaseAudioContext",
      "AudioContext",
      "OfflineAudioContext",
      "AudioNode",
      "AudioSourceNode",
      "AudioDestinationNode",
      "AudioParam",
      "GainNode",
      "DelayNode",
      "AudioBuffer",
      "AudioBufferSourceNode",
      "MediaElementAudioSourceNode",
      "ScriptProcessorNode",
      "JavaScriptNode",
      "PannerNode",
      "AudioListener",
      "SpatialPannerNode",
      "SpatialListener",
      "StereoPannerNode",
      "ConvolverNode",
      "AnalyserNode",
      "ChannelSplitterNode",
      "ChannelMergerNode",
      "DynamicsCompressorNode",
      "BiquadFilterNode",
      "IIRFilterNode",
      "WaveShaperNode",
      "OscillatorNode",
      "PeriodicWave",
      "MediaStreamAudioSourceNode",
      "MediaStreamAudioDestinationNode",
    ];

    var constructorList = {
      "createBuffer": { className: "AudioBuffer", args: [ 1, 128, 44100 ] },
      "createBufferSource": { className: "AudioBufferSourceNode", args: [] },
      "createGain": { className: "GainNode", args: [] },
      "createDelay": { className: "DelayNode", args: [] },
      "createBiquadFilter": { className: "BiquadFilterNode", args: [] },
      "createIIRFilter": { className: "IIRFilterNode", args: [ new Float32Array([1,1], new Float32Array([1,1])) ] },
      "createWaveShaper": { className: "WaveShaperNode", args: [] },
      "createPanner": { className: "PannerNode", args: [] },
      "createConvolver": { className: "ConvolverNode", args: [] },
      "createDynamicsCompressor": { className: "DynamicsCompressorNode", args: [] },
      "createAnalyser": { className: "AnalyserNode", args: [] },
      "createScriptProcessor": { className: "ScriptProcessorNode", args: [ 1024, 1, 1 ] },
      "createStereoPanner": { className: "StereoPannerNode", args: [] },
      "createOscillator": { className: "OscillatorNode", args: [] },
      "createPeriodicWave": { className: "PeriodicWave", args: [ new Float32Array(4), new Float32Array(4) ] },
      "createChannelSplitter": { className: "ChannelSplitterNode", args: [] },
      "createChannelMerger": { className: "ChannelMergerNode", args: [] },
      "createSpatialPanner": { className: "SpatialPannerNode", args: [] },
      "createJavaScriptNode": { className: "JavaScriptNode", args: [ 1024, 1, 1 ] },
      "createMediaElementSource": { className: "MediaElementAudioSourceNode", args: [ new Audio() ] },
      "createMediaStreamDestination": { className: "MediaStreamAudioDestinationNode", args: [] },
    };

    var SILENT_WAV = new Uint32Array([
      0x46464952, 0x00000038, 0x45564157, 0x20746d66,
      0x00000010, 0x00010001, 0x0000ac44, 0x00015888,
      0x00100002, 0x61746164, 0x00000014, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000,
    ]).buffer;

    function checkBaseAudioContextCreateBuffer(audioContext) {
      try {
        if (audioContext.createBuffer(SILENT_WAV, true)) {
          return { "mixToMono": true };
        }
      } catch (e) {}
    }

    function checkBaseAudioContextDecodeAudioData(audioContex) {
      if (audioContext.decodeAudioData(SILENT_WAV, function() {}, function() {})) {
        return { "promise": true };
      }
    }

    function checkAudioNodeConnect(audioContext) {
      var gain = audioContext.createGain();
      var data = {};

      if (gain.connect(audioContext.destination)) {
        data = { "chain": true };
      }

      gain.disconnect();

      return data;
    }

    function checkAudioNodeDisconnect(audioContext) {
      var gain = audioContext.createGain();
      var selective = false;

      try {
        gain.disconnect(audioContext.destination);
      } catch (e) {
        selective = true;
      }

      if (selective === true) {
        return { "selective": true };
      }
    }

    function checkAudioParam(mehtodName, args) {
      return function(audioContext) {
        var gain = audioContext.createGain();

        if (gain.gain[mehtodName].apply(gain.gain, args)) {
          return { "chain": true };
        }
      }
    }

    function checkDynamicsCompressorNodeReduction(audioContext) {
      var compressor = audioContext.createDynamicsCompressor();

      if (typeof compressor.reduction === "number") {
        return { "number": true };
      }
    }

    var specCheckList = {
      "/BaseAudioContext/createBuffer": checkBaseAudioContextCreateBuffer,
      "/BaseAudioContext/decodeAudioData": checkBaseAudioContextDecodeAudioData,

      "/AudioContext/createBuffer": checkBaseAudioContextCreateBuffer,
      "/AudioContext/decodeAudioData": checkBaseAudioContextDecodeAudioData,
      "/AudioContext/startRendering": { "void": true },

      "/AudioNode/connect": checkAudioNodeConnect,
      "/AudioNode/disconnect": checkAudioNodeDisconnect,

      "/AudioParam/cancelScheduledValues": checkAudioParam("cancelScheduledValues", [ 0 ]),
      "/AudioParam/exponentialRampToValueAtTime": checkAudioParam("exponentialRampToValueAtTime", [ 0.1, 0 ]),
      "/AudioParam/linearRampToValueAtTime": checkAudioParam("linearRampToValueAtTime", [ 0, 0 ]),
      "/AudioParam/setTargetAtTime": checkAudioParam("setTargetAtTime", [ 0, 0, 0.1 ]),
      "/AudioParam/setTargetValueAtTime": { "void": true },
      "/AudioParam/setValueAtTime": checkAudioParam("setValueAtTime", [ 0, 0 ]),
      "/AudioParam/setValueCurveAtTime": checkAudioParam("setValueCurveAtTime", [ new Float32Array(8), 0, 1 ]),

      "/DynamicsCompressorNode/reduction": checkDynamicsCompressorNodeReduction,
    };

    var audioContext = new env["AudioContext"]();

    Object.keys(constructorList).forEach(function(methodName) {
      var className = constructorList[methodName].className;
      var args = constructorList[methodName].args;
      if (!env[className] && audioContext[methodName]) {
        try {
          var node = audioContext[methodName].apply(audioContext, args);
          var klass = node.constructor;

          env[klass.name || className] = klass;
        } catch (e) {
          console.error(methodName, e);
        }
      }
    });

    puts('// ' + window.navigator.userAgent);
    puts('');
    puts('{');

    classList.forEach(function(className) {
      if (env[className]) {
        var data = {};

        data["global"] = window[className] ? className : window["webkit" + className] ? "webkit" + className : false;

        try {
          new env[className]();
        } catch (e) {
          if (/illegal constructor/i.test(e.message)) {
            data["protected"] = true;
          }
        }

        if (className === "AudioBuffer") {
          try {
            new AudioBuffer(audioContext, { numberOfChannels: 1, length: 128, sampleRate: 44100 });
            data["context"] = true;
          } catch (e) {}
        }

        puts('  "/' + className + '": ' + stringify(data) + ',');

        Object.getOwnPropertyNames(env[className].prototype).sort().forEach(function(methodName) {
          if (methodName === "constructor") {
            return;
          }
          var apiPath = "/" + className + "/" + methodName;
          var data = {};

          if (typeof specCheckList[apiPath] === "function") {
            Object.assign(data, specCheckList[apiPath](audioContext));
          } else if (typeof specCheckList[apiPath] === "object") {
            Object.assign(data, specCheckList[apiPath]);
          }

          puts('  "' + apiPath + '": ' + stringify(data) + ',');
        });
        puts('');
      }
    });

    puts('}');
  });
  </script>
</body>
</html>
